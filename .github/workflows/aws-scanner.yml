name: AWS Key Scanner - Debug

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "IP/domaines (virgules)"
        required: true
        default: "example.com"
      wordlist_url:
        description: "URL wordlist"
        required: false
        default: "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt"

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Setup
        run: |
          echo "=== Setup Info ==="
          python3 --version
          echo "Target: ${{ github.event.inputs.targets }}"
      
      - name: Install feroxbuster
        run: |
          wget https://github.com/epi052/feroxbuster/releases/latest/download/x86_64-linux-feroxbuster.tar.gz
          tar -xzf x86_64-linux-feroxbuster.tar.gz
          chmod +x feroxbuster
          sudo mv feroxbuster /usr/local/bin/
          feroxbuster --version
      
      - name: Download wordlist
        run: |
          wget -O wordlist.txt "${{ github.event.inputs.wordlist_url }}"
          echo "Wordlist: $(wc -l wordlist.txt)"
          echo "First 20 entries:"
          head -20 wordlist.txt
      
      - name: Create test scanner
        run: echo "aW1wb3J0IGpzb24KaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHVybGxpYi5yZXF1ZXN0CmltcG9ydCB1cmxsaWIuZXJyb3IKaW1wb3J0IHNzbAppbXBvcnQgc3lzCmltcG9ydCB0aW1lCgpwcmludCgiPT09IFNpbXBsZSBTY2FubmVyIFRlc3QgPT09IiwgZmx1c2g9VHJ1ZSkKCnNzbF9jdHggPSBzc2wuX2NyZWF0ZV91bnZlcmlmaWVkX2NvbnRleHQoKQoKZGVmIHRlc3RfZmVyb3hidXN0ZXIodGFyZ2V0LCB3b3JkbGlzdCk6CiAgICAiIiJUZXN0IGZlcm94YnVzdGVyIGF2ZWMgdmVyYm9zZSBvdXRwdXQiIiIKICAgIHByaW50KGYiXG49PT0gVGVzdGluZyBmZXJveGJ1c3RlciBvbiB7dGFyZ2V0fSA9PT0iLCBmbHVzaD1UcnVlKQogICAgCiAgICBjbWQgPSBbImZlcm94YnVzdGVyIiwgIi11IiwgZiJodHRwOi8ve3RhcmdldH0iLCAiLXciLCB3b3JkbGlzdCwgIi12IiwgIi10IiwgIjIwIl0KICAgIHByaW50KGYiQ29tbWFuZDogeycgJy5qb2luKGNtZCl9IiwgZmx1c2g9VHJ1ZSkKICAgIAogICAgc3RhcnQgPSB0aW1lLnRpbWUoKQogICAgcHJvYyA9IHN1YnByb2Nlc3MuUG9wZW4oY21kLCBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLCBzdGRlcnI9c3VicHJvY2Vzcy5TVERPVVQsIHRleHQ9VHJ1ZSkKICAgIAogICAgIyBBZmZpY2hlciBvdXRwdXQgZW4gdGVtcHMgcsOpZWwKICAgIG91dHB1dF9saW5lcyA9IFtdCiAgICBmb3IgbGluZSBpbiBpdGVyKHByb2Muc3Rkb3V0LnJlYWRsaW5lLCAnJyk6CiAgICAgICAgaWYgbGluZToKICAgICAgICAgICAgcHJpbnQoZiJGRVJPWDoge2xpbmUucnN0cmlwKCl9IiwgZmx1c2g9VHJ1ZSkKICAgICAgICAgICAgb3V0cHV0X2xpbmVzLmFwcGVuZChsaW5lKQogICAgCiAgICBwcm9jLndhaXQoKQogICAgZWxhcHNlZCA9IHRpbWUudGltZSgpIC0gc3RhcnQKICAgIAogICAgcHJpbnQoZiJcbkZlcm94YnVzdGVyIGZpbmlzaGVkIGluIHtlbGFwc2VkOi4xZn1zIHdpdGggY29kZSB7cHJvYy5yZXR1cm5jb2RlfSIsIGZsdXNoPVRydWUpCiAgICBwcmludChmIlRvdGFsIG91dHB1dCBsaW5lczoge2xlbihvdXRwdXRfbGluZXMpfSIsIGZsdXNoPVRydWUpCiAgICAKICAgIHJldHVybiBvdXRwdXRfbGluZXMKCmRlZiB0ZXN0X2RpcmVjdF9yZXF1ZXN0cyh0YXJnZXQpOgogICAgIiIiVGVzdCBkaXJlY3Qgc2FucyBmZXJveGJ1c3RlciIiIgogICAgcHJpbnQoZiJcbj09PSBUZXN0aW5nIGRpcmVjdCByZXF1ZXN0cyB0byB7dGFyZ2V0fSA9PT0iLCBmbHVzaD1UcnVlKQogICAgCiAgICB0ZXN0X3BhdGhzID0gWwogICAgICAgICIvIiwKICAgICAgICAiLy5lbnYiLAogICAgICAgICIvaW5mby5waHAiLAogICAgICAgICIvcGhwaW5mby5waHAiLAogICAgICAgICIvYWRtaW4iLAogICAgICAgICIvYmFja3VwIiwKICAgICAgICAiL3Rlc3QiCiAgICBdCiAgICAKICAgIGZpbmRpbmdzID0gW10KICAgIAogICAgZm9yIHBhdGggaW4gdGVzdF9wYXRoczoKICAgICAgICB1cmwgPSBmImh0dHA6Ly97dGFyZ2V0fXtwYXRofSIKICAgICAgICBwcmludChmIlxuVHJ5aW5nOiB7dXJsfSIsIGZsdXNoPVRydWUpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXEgPSB1cmxsaWIucmVxdWVzdC5SZXF1ZXN0KAogICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgbWV0aG9kPSJHRVQiLAogICAgICAgICAgICAgICAgaGVhZGVycz17J1VzZXItQWdlbnQnOiAnTW96aWxsYS81LjAnfQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICB3aXRoIHVybGxpYi5yZXF1ZXN0LnVybG9wZW4ocmVxLCBjb250ZXh0PXNzbF9jdHgsIHRpbWVvdXQ9MTApIGFzIHJlc3A6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSByZXNwLmdldGNvZGUoKQogICAgICAgICAgICAgICAgY29udGVudF9sZW5ndGggPSBsZW4ocmVzcC5yZWFkKCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHByaW50KGYiICDinJMgSFRUUCB7c3RhdHVzfSAtIHtjb250ZW50X2xlbmd0aH0gYnl0ZXMiLCBmbHVzaD1UcnVlKQogICAgICAgICAgICAgICAgZmluZGluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgInNpemUiOiBjb250ZW50X2xlbmd0aAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCB1cmxsaWIuZXJyb3IuSFRUUEVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiICDinJcgSFRUUCB7ZS5jb2RlfSIsIGZsdXNoPVRydWUpCiAgICAgICAgZXhjZXB0IHVybGxpYi5lcnJvci5VUkxFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChmIiAg4pyXIENvbm5lY3Rpb24gZXJyb3I6IHtlLnJlYXNvbn0iLCBmbHVzaD1UcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiIgIOKclyBFcnJvcjoge3R5cGUoZSkuX19uYW1lX199OiB7ZX0iLCBmbHVzaD1UcnVlKQogICAgCiAgICByZXR1cm4gZmluZGluZ3MKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBwcmludChmIkFyZ3VtZW50czoge3N5cy5hcmd2fSIsIGZsdXNoPVRydWUpCiAgICAKICAgIGlmIGxlbihzeXMuYXJndikgPCAzOgogICAgICAgIHByaW50KCJVc2FnZTogcHl0aG9uIHNjYW5uZXIucHkgdGFyZ2V0IHdvcmRsaXN0LnR4dCIsIGZsdXNoPVRydWUpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgdGFyZ2V0ID0gc3lzLmFyZ3ZbMV0uc3BsaXQoIiwiKVswXS5zdHJpcCgpCiAgICB3b3JkbGlzdCA9IHN5cy5hcmd2WzJdCiAgICAKICAgIHByaW50KGYiXG5UYXJnZXQ6IHt0YXJnZXR9IiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGYiV29yZGxpc3Q6IHt3b3JkbGlzdH0iLCBmbHVzaD1UcnVlKQogICAgCiAgICAjIFRlc3QgMTogRGlyZWN0IHJlcXVlc3RzCiAgICBwcmludCgiXG4iICsgIj0iKjUwLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIlRFU1QgMTogRGlyZWN0IEhUVFAgcmVxdWVzdHMiLCBmbHVzaD1UcnVlKQogICAgcHJpbnQoIj0iKjUwLCBmbHVzaD1UcnVlKQogICAgZGlyZWN0X2ZpbmRpbmdzID0gdGVzdF9kaXJlY3RfcmVxdWVzdHModGFyZ2V0KQogICAgCiAgICAjIFRlc3QgMjogRmVyb3hidXN0ZXIKICAgIHByaW50KCJcbiIgKyAiPSIqNTAsIGZsdXNoPVRydWUpCiAgICBwcmludCgiVEVTVCAyOiBGZXJveGJ1c3RlciBzY2FuIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCI9Iio1MCwgZmx1c2g9VHJ1ZSkKICAgIGZlcm94X291dHB1dCA9IHRlc3RfZmVyb3hidXN0ZXIodGFyZ2V0LCB3b3JkbGlzdCkKICAgIAogICAgIyBSZXN1bHRzCiAgICByZXN1bHRzID0gewogICAgICAgICJ0YXJnZXQiOiB0YXJnZXQsCiAgICAgICAgImRpcmVjdF9yZXF1ZXN0cyI6IGRpcmVjdF9maW5kaW5ncywKICAgICAgICAiZmVyb3hidXN0ZXJfbGluZXMiOiBsZW4oZmVyb3hfb3V0cHV0KSwKICAgICAgICAiZmVyb3hidXN0ZXJfc2FtcGxlIjogZmVyb3hfb3V0cHV0WzoxMF0gaWYgZmVyb3hfb3V0cHV0IGVsc2UgW10KICAgIH0KICAgIAogICAgcHJpbnQoIlxuIiArICI9Iio1MCwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCJGSU5BTCBSRVNVTFRTIiwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KCI9Iio1MCwgZmx1c2g9VHJ1ZSkKICAgIHByaW50KGpzb24uZHVtcHMocmVzdWx0cywgaW5kZW50PTIpLCBmbHVzaD1UcnVlKQogICAgCiAgICB3aXRoIG9wZW4oInJlc3VsdHMuanNvbiIsICJ3IikgYXMgZjoKICAgICAgICBqc29uLmR1bXAocmVzdWx0cywgZiwgaW5kZW50PTIpCiAgICAKICAgIHByaW50KGYiXG5SZXN1bHRzIHNhdmVkIHRvIHJlc3VsdHMuanNvbiIsIGZsdXNoPVRydWUpCg==" | base64 -d > scanner.py
      
      - name: Test target connectivity
        run: |
          TARGET=$(echo "${{ github.event.inputs.targets }}" | cut -d',' -f1)
          echo "=== Testing $TARGET ==="
          
          # DNS resolution
          echo "DNS lookup:"
          nslookup $TARGET || echo "DNS failed"
          
          # Ping
          echo -e "\nPing test:"
          ping -c 3 $TARGET || echo "Ping failed (may be blocked)"
          
          # HTTP test
          echo -e "\nHTTP test:"
          curl -v --connect-timeout 10 http://$TARGET 2>&1 | head -30
          
          # Port 80 check
          echo -e "\nPort 80 check:"
          nc -zv -w 5 $TARGET 80 2>&1 || echo "Port 80 closed/filtered"
      
      - name: Manual feroxbuster test
        run: |
          TARGET=$(echo "${{ github.event.inputs.targets }}" | cut -d',' -f1)
          echo "=== Manual feroxbuster test ==="
          
          # Test avec seulement 10 entrÃ©es
          head -10 wordlist.txt > small_wordlist.txt
          
          echo "Testing with small wordlist (10 entries):"
          cat small_wordlist.txt
          
          echo -e "\nRunning feroxbuster..."
          timeout 60s feroxbuster \
            -u http://$TARGET \
            -w small_wordlist.txt \
            -t 10 \
            -d 1 \
            --timeout 5 \
            -v || echo "Feroxbuster finished with code $?"
      
      - name: Run full scanner
        run: |
          echo "=== Running full scanner ==="
          python3 scanner.py "${{ github.event.inputs.targets }}" wordlist.txt
      
      - name: Show all results
        if: always()
        run: |
          echo "=== All files created ==="
          ls -lah
          
          echo -e "\n=== Results ==="
          if [ -f results.json ]; then
            cat results.json
          else
            echo "No results.json found"
          fi
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results
          path: |
            results.json
            *.txt
